#!/usr/bin/env bash
set -euo pipefail

# mise calls: ./bin/install matlab@R2024a
# So first arg is "matlab@R2024a"
if [[ $# -lt 1 ]]; then
  echo "Usage: $0 <plugin@version> (e.g., matlab@R2024a)"
  exit 1
fi

INPUT="$1"

# Extract version from input (format: plugin@version)
if [[ "$INPUT" =~ @(.+) ]]; then
  VERSION="${BASH_REMATCH[1]}"
else
  echo "Error: Expected argument in the form plugin@version, got '$INPUT'"
  exit 1
fi

INSTALL_DIR="${INSTALL_PATH:-"$HOME/.local/share/mise/installs/matlab/$VERSION"}"
MPM_PATH="${HOME}/.local/bin/mpm"

echo "Installing MATLAB $VERSION to $INSTALL_DIR"

# Step 1: Install MPM if missing
if ! command -v mpm &> /dev/null; then
  echo "MPM not found, downloading..."

  mkdir -p "$(dirname "$MPM_PATH")"
  wget -O "$MPM_PATH" https://www.mathworks.com/mpm/glnxa64/mpm
  chmod +x "$MPM_PATH"

  export PATH="$(dirname "$MPM_PATH"):$PATH"
  echo "MPM installed at $MPM_PATH"
else
  echo "MPM already installed."
fi

# Verify mpm is now available
if ! command -v mpm &> /dev/null; then
  echo "Error: mpm command not found after installation."
  exit 1
fi

# Step 2: Install MATLAB using MPM
mpm install --release="$VERSION" --destination="$INSTALL_DIR" --products MATLAB

# Step 3: Create executable shim for matlab

mkdir -p "$INSTALL_DIR/bin"

if [[ -f "$INSTALL_DIR/bin/matlab" && ! -f "$INSTALL_DIR/bin/matlab.real" ]]; then
  mv "$INSTALL_DIR/bin/matlab" "$INSTALL_DIR/bin/matlab.real"
fi

cat <<EOF > "$INSTALL_DIR/bin/matlab"
#!/usr/bin/env bash
exec "$INSTALL_DIR/bin/matlab.real" "\$@"
EOF

chmod +x "$INSTALL_DIR/bin/matlab"

echo "MATLAB $VERSION installed successfully."
